# Generating a Devise model
After all the work we have done before we are ready to add [Devise][devise] to any of our models. Of course not all of our models are gonna need it, only the ones we want authentication goodies for. Usually, we are going to need some kind of authentication for the users of our app, so let's generate a `User` resource with Devise authentication added to it:
```bash
$ rails generate devise User
      invoke  active_record
      create    db/migrate/20151126155108_devise_create_users.rb
      create    app/models/user.rb
      insert    app/models/user.rb
       route  devise_for :users
```
The command above generates 3 things:

1. A `User` model with some **Devise modules** inserted.
2. A line is added to our `routes.rb` file.
3. A database **migration**.

We'll be modifying 2 of these files to suit our needs.

## Cutting down the Devise modules
First of all go to your command line and run:
```bash
$ bundle exec rake routes
```

You'll see quite a bunch of routes, 16 of them. These are being generated by the call to the `devise_for` method in our `routes.rb` file. All of these routes are generated based on what **Devise modules** you have defined in your model.

To gain an understanding of what exactly is brought to the table by each of the Devise's modules, let's start by using just one of them, `DatabaseAuthenticatable`. Make sure that `user.rb` is using just this module:
```ruby
devise :database_authenticatable
```
Delete the other modules referenced in this line, we are not gonna be needing them yet. If you run again:
```bash
$ bundle exec rake routes
```
You'll see that the list of **routes** is much shorter, just 4:

Prefix                   | Verb     | URI Pattern       | Controller#Action
-------------------------|----------|-------------------|-------------------
`new_user_session`       | `GET`    | `/users/sign_in`  | `devise/sessions#new`
`user_session`           | `POST`   | `/users/sign_in`  | `devise/sessions#create`
`destroy_user_session`   | `DELETE` | `/users/sign_out` | `devise/sessions#destroy`
`root_url`               | `GET`    | `/`               | `static_pages#home`

## The migration
Our minimalistic example requires us to trim down our auto-generated **migration file**. To do that comment out (don't delete) all the columns not needed by the `DatabaseAuthenticatable`.

> The commented out lines are gonna be useful later as a reference for future migrations.

This is what your migration should have (comments ommited):

```ruby
class DeviseCreateUsers < ActiveRecord::Migration
  def change
    create_table(:users) do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
  end
end
```
Now we can run the migration:
```bash
$ bundle exec rake db:migrate
```
## Signing in
If we start the server and point our browser to [localhost:3000/users/sign_in][sign_in] we should be able of **signing in** also known as **loging in** into our application. The problem is that we don't have any users yet, and more importantly we have not implemented any functionality to allow users to register themselves. That feature lives in another of Devise's modules, the `Registerable` module, which we are not using so far.

So to test out how the app works, we are gonna have to create a user using the **Rails console**. One minor bump is that we need two **required fields** to create a user:

* The `email` field.
* The `encrypted_password` field.

Making up an **email address** is no biggie, but how do we generate a valid **encrypted password**? If we check the source of the [DatabaseAuthenticatable][l1] module, we can see that it uses a method named `Devise::Encryptor.digest(klass, password)` to generate an encrypted password. This method takes 2 arguments:

1. A **class**, in this case our `User` model.
2. The **password** we want to encrypt.

Knowing that let's crank up the console and generate a user:

```bash
$ rails console
>> pwd = Devise::Encryptor.digest(User,'secret123')
>> User.create(email: 'user@example.com', encrypted_password: pwd)
```
In the second line we generate an encrypted hash of the password `secret123` and store it in the variable named `pwd`, which we use in the last line to create a new user.

If you start your server again, go to [localhost:3000/users/sign_in][sign_in] and log in with the credentials of the newly created user, you will be successfully logged in and redirected to the root path. Also, a dismissible flash message beautifully styled with Bootstrap will acknowledge this fact.

![signed_in][i1]

## Signing out
We also have a **route** in place to **sign out** aka **log out** of our application, but to try it out with our browser is a bit more complicated because this route works with a `DELETE` request to `localhost:3000/users/sign_out`. You have a couple of options to give this a go:

* You can use some browser plugin like [Postman][l2] that allows us to generate all type of **HTTP requests**.
* Or use the good old [cURL][l3] which is a command line utility that allows the same. Something like:

  ```bash
  $ curl --request DELETE http://localhost:3000/users/sign_out
  ```

The problem with any of these 2 approaches is that since they work outside the browser, the request will be successfully sent but it will not work: We are not sending the `authenticity_token` we received when we logged in, or any of the other required parameters such as `email` and `password`. As a result, the user won't be logged out.

So if we try to log in again, we will received a flash message:

![already_in][i2]

Bottom line, we'll have to make this request from our browser and for that we'll need to have in place the proper markup.

## Adding some buttons to our navigation bar
What we would like to do is add a button to the bar so the user can click and is taken to the sessions view. Also, once the user is **logged in** and only when is logged in, a **log out** button will appear, allowing the user to log out of the app. This is the markup we've added to the [navigation partial][l4]:  
```html
<div class="navbar-right">
  <% if user_signed_in? %>
    <%= link_to "Log out", destroy_user_session_path, method: "delete", class: 'btn btn-warning navbar-btn' %>
    <p class="navbar-text">Logged in as <%= current_user.email %></p>
  <% else %>
    <%= link_to "Log in", new_user_session_path, class: 'btn btn-success navbar-btn' %>
  <% end %>
</div>
```

* Notice the use of the `user_signed_in?` method, which is a **helper method** offered by [Devise][devise]. This method returns a **boolean**, if it's `true` we show the "Log out" button, otherwise the "Log in" button will appear.
* We are using another **helper** named `current_user` that is available when a user is logged in. It returns a `User` object, we are accessing the `email` attribute and showing it if the user is logged in.

## Pimping out our sessions view
Last thing we are going to do here is add some style to the view we are using for logging into the app. So inside `views/sessions` we are going to add some HTML markup to the `new.html.erb` file, basically to provide classes to hook up [Bootstrap][bootie] styles. Check the source code of [this view][l5] to see what we've done.

> If you want to see how the project looks like so far, checkout the `version-0.2` branch and run `rails server`.

---
[:arrow_backward:][back] | [:house:][home] | [:arrow_forward:][next]

<!-- link references -->
[home]: ../README.md
[back]: getting_started.md
[next]: adding_another_page.md

[devise]: https://github.com/plataformatec/devise
[bootie]: https://github.com/twbs/bootstrap-sass
[sign_in]: http://localhost:3000/users/sign_in
[l1]: https://github.com/plataformatec/devise/blob/master/lib/devise/models/database_authenticatable.rb
[l2]: https://www.getpostman.com/
[l3]: http://curl.haxx.se/
[l4]: https://github.com/lifeBalance/divine/blob/version-0.2/app/views/shared/_navigation.html.erb
[l5]: https://github.com/lifeBalance/divine/blob/version-0.2/app/views/devise/sessions/new.html.erb

<!-- image references -->
[i1]: img/signed_in_success.png
[i2]: img/already_in.png
